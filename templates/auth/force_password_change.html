{% extends "auth/base_auth.html" %}
{% load static %}

{% block title %}Change Password{% endblock %}

{% block content %}

<div class="text-center mb-4">
    <h4 class="fw-bold">Change Your Password</h4>
    <p class="text-muted">For security reasons, you must set a new password before continuing.</p>
</div>

{% if messages %}
<div class="alert alert-danger" id="django-alert">
    {% for m in messages %}
        <div>{{ m }}</div>
    {% endfor %}
</div>

<script>
    setTimeout(function () {
        let box = document.getElementById("django-alert");
        if (box) {
            box.classList.add("fade");
            box.style.opacity = "0";
            setTimeout(() => box.remove(), 500);
        }
    }, 3000);
</script>
{% endif %}

<form method="POST" class="mt-3" onsubmit="return validateForm()">
    {% csrf_token %}

    <!-- New Password -->
    <div class="mb-3">
        <label class="form-label">New Password</label>
        <div class="input-group">
            <input type="password" name="password" id="passwordField"
                   class="form-control" placeholder="Enter new password" required>
            <span class="input-group-text" id="togglePassword" style="cursor:pointer;">
                <i class="fa fa-eye"></i>
            </span>
        </div>

        <small id="strengthText" class="text-muted"></small>
        <div class="progress mt-2" style="height:6px;">
            <div id="strengthBar" class="progress-bar"></div>
        </div>
    </div>

    <!-- Confirm Password -->
    <div class="mb-3">
        <label class="form-label">Confirm Password</label>
        <div class="input-group">
            <input type="password" id="confirmPasswordField"
                   class="form-control" placeholder="Re-enter new password" required>
            <span class="input-group-text" id="toggleConfirm" style="cursor:pointer;">
                <i class="fa fa-eye"></i>
            </span>
        </div>

        <small id="matchText" class="text-danger"></small>
    </div>

    <button type="submit" class="btn btn-primary w-100 mt-3" id="submitBtn" disabled>
        Save Password
    </button>
</form>

<script>
// ---------------------------
// SHOW/HIDE PASSWORD FIELDS
// ---------------------------
function toggleField(fieldId, toggleId) {
    const input = document.getElementById(fieldId);
    const toggle = document.getElementById(toggleId);

    toggle.addEventListener("click", () => {
        const type = input.type === "password" ? "text" : "password";
        input.type = type;
        toggle.innerHTML = `<i class="fa ${type === "password" ? "fa-eye" : "fa-eye-slash"}"></i>`;
    });
}

toggleField("passwordField", "togglePassword");
toggleField("confirmPasswordField", "toggleConfirm");

// ---------------------------
// PASSWORD STRENGTH METER
// ---------------------------
const passField = document.getElementById("passwordField");
const strengthBar = document.getElementById("strengthBar");
const strengthText = document.getElementById("strengthText");

passField.addEventListener("input", function () {
    let val = passField.value;
    let strength = 0;

    if (val.length >= 6) strength++;
    if (/[A-Z]/.test(val)) strength++;
    if (/[0-9]/.test(val)) strength++;
    if (/[^A-Za-z0-9]/.test(val)) strength++;

    let width = (strength / 4) * 100;
    strengthBar.style.width = width + "%";

    if (strength === 0) {
        strengthBar.className = "progress-bar bg-danger";
        strengthText.innerHTML = "Too weak";
    } else if (strength === 1) {
        strengthBar.className = "progress-bar bg-danger";
        strengthText.innerHTML = "Weak";
    } else if (strength === 2) {
        strengthBar.className = "progress-bar bg-warning";
        strengthText.innerHTML = "Fair";
    } else if (strength === 3) {
        strengthBar.className = "progress-bar bg-info";
        strengthText.innerHTML = "Good";
    } else if (strength === 4) {
        strengthBar.className = "progress-bar bg-success";
        strengthText.innerHTML = "Strong";
    }
});

// ---------------------------
// PASSWORD MATCH VALIDATION
// ---------------------------
const confirmField = document.getElementById("confirmPasswordField");
const matchText = document.getElementById("matchText");
const submitBtn = document.getElementById("submitBtn");

function checkMatch() {
    let pass = passField.value;
    let confirmPass = confirmField.value;

    if (!confirmPass) {
        matchText.innerHTML = "";
        submitBtn.disabled = true;
        return;
    }

    if (pass === confirmPass) {
        matchText.innerHTML = "✔ Passwords match";
        matchText.classList.remove("text-danger");
        matchText.classList.add("text-success");
        submitBtn.disabled = false;
    } else {
        matchText.innerHTML = "✖ Passwords do not match";
        matchText.classList.remove("text-success");
        matchText.classList.add("text-danger");
        submitBtn.disabled = true;
    }
}

passField.addEventListener("input", checkMatch);
confirmField.addEventListener("input", checkMatch);

// ---------------------------
// FORM SUBMIT VALIDATION
// ---------------------------
function validateForm() {
    if (submitBtn.disabled) {
        alert("Passwords do not match.");
        return false;
    }
    return true;
}

</script>

{% endblock %}
