{% extends "partials/base.html" %}
{% load static %}
{% load get_subject %}

{% block layout %}

<div class="container mt-4">

    <div class="d-flex justify-content-between">
        <h3>Classes</h3>

        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClassModal">
            <i class="fi fi-rr-plus"></i> Add Class
        </button>
    </div>

    <hr>

    {% if messages %}
        {% for m in messages %}
            <div class="alert alert-{{ m.tags }} mt-2 flash-message">{{ m }}</div>
        {% endfor %}
    {% endif %}

    <div class="card shadow-sm">
        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th>Level</th>
                    <th>Class Name</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for c in classes %}
                <tr>
                    <td>{{ c.level.name }}</td>

<td>
    {{ c.name }}

    {% if c.assigned_subjects %}
        <small class="text-primary fs-7" style="font-size: 0.55rem;">
            (
            {% for s in c.assigned_subjects %}
                {{ s.subject.name }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
            )
        </small>
    {% else %}
        <small class="text-muted"> ( No subjects assigned.)</small>
    {% endif %}
</td>

<td class="text-start">

    <div class="dropdown">
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                type="button"
                data-bs-toggle="dropdown">
            Actions
        </button>

        <ul class="dropdown-menu">

            <li>
                <a class="dropdown-item text-success"
                   href="#"
                   data-bs-toggle="modal"
                   data-bs-target="#assignSubjectsModal{{ c.id }}">
                   Assign Subjects
                </a>
            </li>

            <li>
                <a class="dropdown-item text-primary"
                   href="#"
                   data-bs-toggle="modal"
                   data-bs-target="#editClassModal{{ c.id }}">
                   Edit
                </a>
            </li>

            <li>
                <a class="dropdown-item text-danger"
                   href="#"
                   data-bs-toggle="modal"
                   data-bs-target="#deleteClassModal{{ c.id }}">
                   Delete
                </a>
            </li>

        </ul>
    </div>

</td>

                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" class="text-center text-muted">No classes added.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>


<!-- ============================================================= -->
<!-- ADD CLASS MODAL                                               -->
<!-- ============================================================= -->
<div class="modal fade" id="addClassModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST">
        {% csrf_token %}
        <div class="modal-header">
            <h5 class="modal-title">Add Class</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            {{ form.as_p }}
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- ============================================================= -->
<!-- CLASS MODALS (EDIT, DELETE, ASSIGN SUBJECTS)                  -->
<!-- These MUST be outside the table!                              -->
<!-- ============================================================= -->

{% for c in classes %}

<!-- ======================= EDIT CLASS ======================== -->
<div class="modal fade" id="editClassModal{{ c.id }}">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{% url 'profile:edit_class' c.id %}">
        {% csrf_token %}
        <div class="modal-header">
            <h5 class="modal-title">Edit Class</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            {{ c.form.as_p }}
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary">Save Changes</button>
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ======================= DELETE CLASS ====================== -->
<div class="modal fade" id="deleteClassModal{{ c.id }}">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Delete Class</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete:</p>
            <strong>{{ c.name }} ({{ c.level.name }})</strong>
        </div>
        <div classodal-footer">
            <a href="{% url 'profile:delete_class' c.id %}" class="btn btn-danger">Delete</a>
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        </div>
    </div>
  </div>
</div>

<!-- =================== ASSIGN SUBJECTS MODAL ================== -->
<div class="modal fade" id="assignSubjectsModal{{ c.id }}">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <form method="POST" action="{% url 'profile:assign_subjects_to_class' c.id %}">
        {% csrf_token %}

        <div class="modal-header">
            <h5 class="modal-title">Assign Subjects to {{ c.name }}</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Subject</th>
                        <th>Type</th>
                    </tr>
                </thead>

                <tbody>
                    {% for subject in subjects %}
                    {% with cs=c.assigned_subjects|get_subject:subject.id %}
                    <tr>
                        <td>
                            <input type="checkbox"
                                   name="subject_ids"
                                   value="{{ subject.id }}"
                                   {% if cs %}checked{% endif %}>
                        </td>

                        <td>{{ subject.name }}</td>

                        <td>
                            <select name="type_{{ subject.id }}" class="form-control">
                                <option value="mandatory"
                                        {% if cs and cs.is_mandatory %}selected{% endif %}>
                                    Mandatory
                                </option>
                                <option value="optional"
                                        {% if cs and cs.is_optional %}selected{% endif %}>
                                    Optional
                                </option>
                            </select>
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>

        </div>

        <div class="modal-footer">
            <button class="btn btn-success">Save Subjects</button>
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
        </div>

      </form>

    </div>
  </div>
</div>

{% endfor %}


{% endblock %}
